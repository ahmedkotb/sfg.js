<html>
    <head>
        <link rel="stylesheet" href="sfg.css" type="text/css"/>
        <script type="text/javascript" src="sfg.js"></script>
        <script type="text/javascript">
            var sfg = null;

            function init(){
                var canvas = document.getElementById("canvas");
                sfg = new SFG(canvas);
                refreshSymbolsTable();
            }

            function addNode(){
                sfg.startAddingNode();
            }

            function addLineEdge(){
                sfg.startAddingLineEdge();
                refreshSymbolsTable();
            }

            function addArcEdge(){
                sfg.startAddingArcEdge();
                refreshSymbolsTable();
            }

            function deleteItem(){
                sfg.deleteSelected();
                refreshSymbolsTable();
            }

            function solve(){
                var result = null;
                var source = prompt("Source node name ?","");
                if (source){
                    var dest = prompt("Destination node name ?","");
                    if (dest)
                        result = sfg.solve(source,dest);
                    else
                        return;

                }else
                    return;
                var padStr = function (str,length,chr){
                    var pad = (length-str.length)/2;
                    var c = 0;
                    while (c < pad){
                        str = chr + str;
                        c++;
                    }
                    c = 0;
                    while (c < pad){
                        str += chr;
                        c++;
                    }
                    return str;
                }
                document.getElementById("results");
                results.innerHTML = "";
                var symHTML = "<h3> Symbolic </h3>";
                var deltaLen = result.sym.delta.length;
                var numLen = result.sym.num.length;
                var line = "";
                if (numLen < deltaLen) {
                    result.sym.num = padStr(result.sym.num,deltaLen," ");
                    line = padStr(line,deltaLen,"_");
                }else{
                    result.sym.delta = padStr(result.sym.delta,numLen," ");
                    line = padStr(line,numLen,"-");
                }

                symHTML += "<pre>" + result.sym.num + "</pre>";
                symHTML += line;
                symHTML += "<pre>" +result.sym.delta+ "</pre>";
                symHTML += "<br/>";
                symHTML += "<h3> Numeric </h3>";
                symHTML += result.numeric.num + " / " + result.numeric.delta
                        + " = " + result.numeric.num/result.numeric.delta;
                results.innerHTML = symHTML;
            }

            function refreshSymbolsTable(){
                var symbols = sfg.getSymbols();

                //sort symbols alphabetically
                symbols.sort(function(a,b){
                    if (a.sym < b.sym) return -1;
                    else if (a.sym > b.sym) return 1;
                    return 0;
                });

                var table = document.getElementById("symtable");
                //clear table
                while (table.rows.length > 1)
                    table.deleteRow(table.rows.length-1);

                var clickFunction = function(row,symbol,value){
                    row.onclick = function(){
                        var newValue = prompt("New value for " + symbol + " ?", value);
                        if (newValue){
                            var v = parseFloat(newValue);
                            if (!isNaN(v)){
                                sfg.setSymbolValue(symbol,v);
                                refreshSymbolsTable();
                            }
                            else
                                alert("Not a valid number");
                        }
                    }

                }

                for (var i=0;i<symbols.length;i++){
                    var symbol = symbols[i].sym;
                    var value = symbols[i].value;

                    var row = table.insertRow(table.rows.length);
                    if (i%2 == 0)
                        row.className = "even";
                    else
                        row.className = "odd";
                    clickFunction(row,symbol,value);

                    var cellLeft = row.insertCell(0);
                    var textNode = document.createTextNode(symbol);
                    cellLeft.appendChild(textNode);

                    var cellRight = row.insertCell(1);
                    var textNode = document.createTextNode(value);
                    cellRight.appendChild(textNode);
                }
            }

            function clearAll(){
                sfg.clear();
                refreshSymbolsTable();
            }

            function editLabel(){
                if (sfg.isSomethingSelected()){
                    var label = prompt("New Label",sfg.getSelectedLabel());
                    if (label){
                        sfg.setSelectedLabel(label);
                        refreshSymbolsTable();
                    }
                }
            }
        </script>
  </head>
  <body onload = "init()">
      <div align="center">
          <h2>SFG</h2>
      </div>
      <div>
          <button id= "addNode" onclick="addNode()" > add node </button>
          <button id= "addLineEdge" onclick="addLineEdge()" > add line edge </button>
          <button id= "addArcEdge" onclick="addArcEdge()" > add arc edge </button>

          <button id= "deleteItem" onclick="deleteItem()" > delete selected </button>
          <button id= "clear" onclick="clearAll()" > clear</button>
          <button id= "zoomIn" onclick="sfg.zoomIn()" > + </button>
          <button id= "zoomOut" onclick="sfg.zoomOut()" > - </button>
          <button id= "solve" onclick="solve()" > Solve </button>
          <button id= "editLabel" onclick="editLabel()" > Edit Label</button>
          <br/>
          <div width="600px" style = "float:left;margin-right:20px">
              <canvas id="canvas" width="800px" height="400px" style="border:solid;">
                sfg canvas
              </canvas>
          </div>
          <div style="height:150px;width:170px;overflow-y:auto;display:inline-block" title="click on a symbol to change its value">
              <table id="symtable">
                  <tr>
                      <th> Symbol </th>
                      <th> Value </th>
                  </tr>
              </table>
          </div>
      </div>
      <div style="clear:left">
        <h2> Results </h2>
        <div id="results" style="height:100px;width:800px;border:1px solid black;overflow:auto;padding:10px">
        </div>
      </div>

      <div id="debug">
      </div>
  </body>
</html>
